# Database Schema for SMile Application

## 1. Custom Types (ENUMs)

```sql
CREATE TYPE body_part_enum AS ENUM (
  'Head',
  'Neck',
  'Back',
  'Arms',
  'LeftHand',
  'RightHand',
  'LeftLeg',
  'RightLeg'
);

CREATE TYPE pain_type_enum AS ENUM (
  'Tingle',
  'Numbness',
  'Cramps',
  'FuckedUp'
);
```

## 2. Tables

### `users`
This table is managed by Supabase auth

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  first_name TEXT,
  last_name TEXT,
  date_of_birth DATE,
  height_cm SMALLINT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ
);

COMMENT ON TABLE users IS 'Stores public user data, extending the Supabase auth.users table.';
```

### `weight_records`
Stores daily weight measurements for users.

```sql
CREATE TABLE weight_records (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  weight_kg DECIMAL(5, 2) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE weight_records IS 'Stores daily weight records for users.';
```

### `blood_pressure_records`
Stores daily blood pressure and pulse measurements.

```sql
CREATE TABLE blood_pressure_records (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  systolic SMALLINT NOT NULL,
  diastolic SMALLINT NOT NULL,
  pulse SMALLINT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE blood_pressure_records IS 'Stores blood pressure and pulse records.';
```

### `symptom_records`
Stores records of neurological symptoms experienced by users.

```sql
CREATE TABLE symptom_records (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  body_part body_part_enum NOT NULL,
  pain_type pain_type_enum NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE symptom_records IS 'Stores records of neurological symptoms.';
```

## 3. Relationships
- **`auth.users` ↔ `users`**: One-to-One. Each user in `auth.users` has exactly one corresponding entry in `users`.
- **`users` → `weight_records`**: One-to-Many. Each user can have multiple weight records.
- **`users` → `blood_pressure_records`**: One-to-Many. Each user can have multiple blood pressure records.
- **`users` → `symptom_records`**: One-to-Many. Each user can have multiple symptom records.

Foreign keys are defined with `ON DELETE CASCADE` to ensure that when a user is deleted, all their associated data (profile, weight, blood pressure, and symptom records) is also automatically deleted.

## 4. Indexes
Indexes are created on foreign keys and date columns to optimize query performance, especially for filtering data for charts and historical views.

```sql
-- Index on foreign key in users table
CREATE INDEX idx_users_user_id ON users(user_id);

-- Indexes on foreign keys and date columns for record tables
CREATE INDEX idx_weight_records_user_id ON weight_records(user_id);
CREATE INDEX idx_weight_records_date ON weight_records(date);

CREATE INDEX idx_blood_pressure_records_user_id ON blood_pressure_records(user_id);
CREATE INDEX idx_blood_pressure_records_date ON blood_pressure_records(date);

CREATE INDEX idx_symptom_records_user_id ON symptom_records(user_id);
CREATE INDEX idx_symptom_records_date ON symptom_records(date);
```

## 5. Row-Level Security (RLS) Policies
RLS is enabled for all tables to ensure that users can only access and modify their own data.

```sql
-- Enable RLS for all tables
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE weight_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE blood_pressure_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE symptom_records ENABLE ROW LEVEL SECURITY;

-- Policy for users
CREATE POLICY "Users can manage their own user data"
ON users FOR ALL
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- Policies for record tables
CREATE POLICY "Users can manage their own weight records"
ON weight_records FOR ALL
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can manage their own blood pressure records"
ON blood_pressure_records FOR ALL
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can manage their own symptom records"
ON symptom_records FOR ALL
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());
```

## 6. Triggers and Functions

### Automatically create a profile for new users
This function and trigger automatically insert a new row into `users` when a new user signs up via Supabase Auth.

```sql
-- Function to be called by the trigger
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO users (id)
  VALUES (new.id);
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger that calls the function after a new user is created
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW EXECUTE PROCEDURE handle_new_user();
```

### Automatically update `updated_at` timestamp
This function and trigger automatically update the `updated_at` column in the `users` table whenever a row is modified.

```sql
-- Function to update the timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
   NEW.updated_at = now(); 
   RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to call the function before an update
CREATE TRIGGER update_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();
```

## 7. Additional Notes
- **Validation**: Per the planning session, data validation (e.g., weight range) is not handled at the database level with `CHECK` constraints. This responsibility is delegated entirely to the application layer (frontend and API). It is critical to implement robust validation there to ensure data integrity.
- **Schema**: All tables and functions are created within the `public` schema by default, so the schema is not explicitly specified in the SQL statements.